# 5. 웹서버

# 5.1. 다채로운 웹 서버

웹 서버는 HTTP 요청을 처리하고 응답을 처리하는 하드웨어 장비나 소프트웨어로 매우 다양하다.

## 5.1.1. 웹 서버 구현

웹 서버는 HTTP 프로토콜을 구현하고, 웹 리소스를 관리하고, 웹 서버 관리 기능(설정, 통제, 확장)을 제공한다.

## 5.1.2. 다목적 소프트웨어 웹 서버

nginx, apache, ms, google등 많은 웹서버가 있다. 최근에는 nginx를 가장 많이 사용한다.

![스크린샷 2023-05-09 16.27.27.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/abf0ccf6-4997-46b0-8d83-69238b29d2ae/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-05-09_16.27.27.png)

## 5.1.3. 임베디드 웹 서버

소비자용 제품에 내장될 목적으로 만들어진 작은 웹 서버이다.

# 5.2. 간단한 펄 웹 서버

요지는 완전한 기능을 갖춘 HTTP 서버를 만들려면 해야 할 일이 많지만, 최소한의 기능을 가진 HTTP서버를 아주 짧은 Perl 코드로 만들수 있단 뜻이다. 사실 Node.js가 더 짧다.

# 5.3. 진짜 웹 서버가 하는 일

![스크린샷 2023-05-09 16.32.42.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1f7935e2-c8a9-4090-be1d-928c2494067e/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-05-09_16.32.42.png)

1. 커넥션을 맺는다. — 클라이언트의 접속을 받아들이거나, 원치 않는 클라이언트라면 닫는다.
2. 요청을 받는다. — 요청 메시지를 해석하고 행동을 취한다.
3. 요청을 처리한다. — 요청 메시지를 해석하고 행동을 취한다.
4. 리소스에 접근한다. — 메시지에서 지정한 리소스에 접근한다.
5. 응답을 만든다. — 올바른 헤더를 포함한 HTTP 응답 메시지를 생성한다.
6. 응답을 보낸다. — 응답을 클라이언트에게 돌려준다.
7. 트랜잭션을 로그로 남긴다. — 로그파일에 트랜잭션 완료에 대한 기록을 남긴다.

# 5.4. 단계 1: 클라이언트 커넥션 수락

클라이언트가 이미 서버에 대해 열려있는 지속적 커넥션을 갖고 있다면, 있는 것을 사용하고 없다면 새 커넥션을 생성해야 한다.

## 5.4.1. 새 커넥션 다루기

서버는 연결된 클라이언트의 IP 정보를 기반으로 커넥션을 생성한다. IP 주소를 검증하여 필요에 따라 커넥션을 닫을 수 있다.

## 5.4.2. 클라이언트 호스트 명 식별

역방향 DNS를 통해 IP로 부터 호스트명을 얻고 호스트명을 분석한다.

일반적으로 DNS 조회는 포워드로 이뤄지지만 리버스(역방향) DNS는 IP주소로 도메인 네임을 얻는다.

## 5.4.3. ident를 통해 클라이언트 사용자 알아내기

서버에서 ident 값을 확인하는 별도의 절차가 있다. 113번 포트를 사용한다. 하지만 많은 소프트웨어가 지원하지 않아서 잘 사용되지 않는다.

# 5.5. 단계 2: 요청 메시지 수신

서버는 요청 메시지를 파싱한다.

- 요청줄(요청 메시지의 시작줄)을 파싱하여 요청 메서드, 리소스(URL), 버전 정보를 찾는다. 각 값은 스페이스 한 개로 분리돼 있고 끝에는 CRLF로 끝난다.
- 메시지 헤더를 읽는다. 각 헤더는 CRLF로 끝난다.
- 헤더의 끝을 의미하는 CRLF로 끝나는 빈줄(개행)을 찾고 존재한다면 아래 본문을 읽는다.
- 파싱을 끝낸다.

## 5.5.1. 메시지의 내부 표현

메시지를 내부의 자료구조로 파싱해 가지고 있는다.

![스크린샷 2023-05-09 17.10.05.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b4e6d538-976d-464f-a38e-53a3c5d86f58/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-05-09_17.10.05.png)

## 5.5.2. 커넥션 입력/출력 처리 아키텍처

고성능 웹 서버는 수천 개의 커넥션을 동시에 열 수 있다.

![스크린샷 2023-05-09 17.11.06.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3c48f8c6-c338-4b37-9fbb-23a06ffc2773/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-05-09_17.11.06.png)

# 5.6. 단계 3: 요청 처리

요청 처리는 뒤에서 다룬다.

# 5.7. 단계 4: 리소스의 매핑과 접근

웹 서버는 리소스 서버로, URI에 접근하면 컨텐츠를 제공해준다.

## 5.7.1. Docroot

웹 서버 파일 시스템의 특별한 폴더를 웹 콘텐츠를 위해 설정한다. 아파치 웹 서버를 기준으로 `/usr/local/httpd/files` 폴더에 해당한다.

만약 https://www.kakao.com/logo.wepb 에 접근한다면 해당 서버의 /usr/local/httpd/files/logo.webp 에 접근하는 식이다.

여기서 서버는 상대적인 url이 docroot 이외 부분이 노출되지 않게 해야한다. 예를들면 https://www.kakako.com/ 처럼 디렉토리의 부모에 접근하는 것을 막아야한다.

또한 docroot를 사용할 때 가상 호스팅 방식으로 하나의 웹 서버에서 여러 루트를 사용할 수 있다.

![스크린샷 2023-05-09 17.29.17.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ae6f4ffd-c949-4268-b11a-248329e3f0b4/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-05-09_17.29.17.png)

```xml
<VirtualHost www.joes-hardware.com> 
  ServerName www.joes-hardware.com 
  DocumentRoot /docs/joe 
  TransferLog /logs/joe.access_log 
  ErrorLog /logs/joe.error_log 
</VirtualHost> 

<VirtualHost www.marys-antiques.com> 
  ServerName www.marys-antiques.com 
  DocumentRoot /docs/mary 
  TransferLog /logs/mary.access_log 
  ErrorLog /logs/mary.error_log 
</VirtualHost>
```

## 5.7.2. 디렉터리 목록

웹 서버는 디렉터리에 대한 URL을 받으면 해당 디렉터리에 있는 index.html 파일(보통은 웹 페이지의 시작 점)을 환한다.

## 5.7.3. 동적 콘텐츠 리소스 매핑

웹 서버는 디렉토리나 파일의 위치를 매핑할수 있다.

## 5.7.4. 서버사이드 인클루드(Server-Side Includes, SSI)

PHP, JSP, EJS등 어떤 리소스가 서버사이드 인클루드를 포함한다면 클라이언트에게 보내기 전에 처리한다. 간단히 말해서 HTML파일에 특정한 패턴(주로 HTML 주석안에 포함)이 있다면 그 패턴에 있는 파일, 변수, 스크립트를 치환한다.

```tsx
<!-- #include 속성="파일명" -->
```

요즘은.. 다른 더 좋은 방법이 많다.

## 5.7.5. 접근 제어

HTTP 인증과 관련 있고 12장에서 자세히 다룬다. 각각의 리소스에 접근 제어를 할당 가능하다.

# 5.8. 단계 5: 응답 만들기

서버는 요청에 대해 적절한 응답을 만들어 반환한다.

## 5.8.1. 응답 엔터티

응답 본문이 있다면 주로 다음 내용을 포함한다.

- MIME를 서술하는 Content-Type
- 응답 본문 길이인 Content-Length
- 실제 응답 본문 내용

## 5.8.2. 리다이렉션

필요에 따라 어떤 요청 후 클라이언트에게 이동할 위치를 줄 수 있다. Location 응답 헤더는 페이지를 리다이렉션할 URL을 나타낸다.

# 5.9. 단계 6: 응답 보내기

커넥션에 응답을 보낸다. 요청과 마찬가지로 커넥션의 수는 제한적이기 때문에 커넥션을 잘 관리하는 것이 중요하다. 그리고 지속적인 커넥션이면 Content-Length를 올바른 값으로 줘야한다.

# 5.10. 단계 7: 로깅

웹 서버에서 수행한 내용을 기록한다. 21장에서 더 자세히 다룬다.

